name: Slack Detailed Commit Notification
on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract comprehensive commit info
        id: extract
        run: |
          # Get basic commit info
          COMMIT_HASH=$(git log -1 --pretty=format:'%H')
          COMMIT_SHORT_HASH=$(git log -1 --pretty=format:'%h')
          AUTHOR_NAME=$(git log -1 --pretty=format:'%an')
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          COMMIT_BODY=$(git log -1 --pretty=format:'%b')
          COMMIT_DATE=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M:%S UTC')
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${COMMIT_HASH}"
          
          # Get GitHub actor (who triggered the push)
          ACTOR="${{ github.actor }}"
          ACTOR_URL="https://github.com/${ACTOR}"
          
          # Get changed files and stats
          if [ $(git rev-list --count HEAD) -gt 1 ]; then
            CHANGED_FILES_COUNT=$(git diff --name-only HEAD~1 HEAD | wc -l)
            STATS=$(git diff --shortstat HEAD~1 HEAD 2>/dev/null || echo "0 files changed")
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | head -10 | tr '\n' '\\n')
          else
            CHANGED_FILES_COUNT=$(git diff --name-only HEAD | wc -l)
            STATS=$(git diff --shortstat HEAD 2>/dev/null || echo "0 files changed")
            CHANGED_FILES=$(git diff --name-only HEAD | head -10 | tr '\n' '\\n')
          fi
          
          # Extract PR info from commit message if it's a merge
          PR_INFO=""
          PR_NUMBER=""
          PR_TITLE=""
          
          # Pattern 1: Merge pull request #123 from branch
          if [[ "$COMMIT_MESSAGE" =~ Merge\ pull\ request\ #([0-9]+) ]]; then
            PR_NUMBER="${BASH_REMATCH[1]}"
            PR_URL="https://github.com/${{ github.repository }}/pull/${PR_NUMBER}"
            # Extract PR title (everything after the PR number)
            PR_TITLE=$(echo "$COMMIT_MESSAGE" | sed -n 's/.*Merge pull request #[0-9]* from [^ ]* //p')
            PR_INFO="*üìã Pull Request:*\n<${PR_URL}|#${PR_NUMBER} - ${PR_TITLE}>"
          
          # Pattern 2: Squash merge with (#123) at end
          elif [[ "$COMMIT_MESSAGE" =~ \(#([0-9]+)\)$ ]]; then
            PR_NUMBER="${BASH_REMATCH[1]}"
            PR_URL="https://github.com/${{ github.repository }}/pull/${PR_NUMBER}"
            # Remove PR number from commit message to get title
            PR_TITLE=$(echo "$COMMIT_MESSAGE" | sed 's/ (#[0-9]*)//')
            PR_INFO="*üìã Pull Request:*\n<${PR_URL}|#${PR_NUMBER} - ${PR_TITLE}>"
          fi
          
          # Get author GitHub profile if possible
          AUTHOR_PROFILE=""
          if [[ "$AUTHOR_EMAIL" == *"@users.noreply.github.com" ]]; then
            GITHUB_USER=$(echo "$AUTHOR_EMAIL" | cut -d'@' -f1)
            AUTHOR_PROFILE="https://github.com/${GITHUB_USER}"
            AUTHOR_LINK="<${AUTHOR_PROFILE}|${AUTHOR_NAME}>"
          else
            AUTHOR_LINK="${AUTHOR_NAME}"
          fi
          
          # Format files list for Slack
          if [ -n "$CHANGED_FILES" ]; then
            FORMATTED_FILES=$(echo -e "$CHANGED_FILES" | sed 's/\\n/\n‚Ä¢ /g')
            FORMATTED_FILES="‚Ä¢ ${FORMATTED_FILES}"
            if [ $CHANGED_FILES_COUNT -gt 10 ]; then
              FORMATTED_FILES="${FORMATTED_FILES}\n‚Ä¢ ... and $((CHANGED_FILES_COUNT - 10)) more files"
            fi
          else
            FORMATTED_FILES="No files changed"
          fi
          
          # Set outputs
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "commit_short_hash=${COMMIT_SHORT_HASH}" >> $GITHUB_OUTPUT
          echo "author_name=${AUTHOR_NAME}" >> $GITHUB_OUTPUT
          echo "author_email=${AUTHOR_EMAIL}" >> $GITHUB_OUTPUT
          echo "author_link=${AUTHOR_LINK}" >> $GITHUB_OUTPUT
          echo "commit_message=${COMMIT_MESSAGE}" >> $GITHUB_OUTPUT
          echo "commit_body=${COMMIT_BODY}" >> $GITHUB_OUTPUT
          echo "commit_date=${COMMIT_DATE}" >> $GITHUB_OUTPUT
          echo "commit_url=${COMMIT_URL}" >> $GITHUB_OUTPUT
          echo "actor=${ACTOR}" >> $GITHUB_OUTPUT
          echo "actor_url=${ACTOR_URL}" >> $GITHUB_OUTPUT
          echo "changed_files_count=${CHANGED_FILES_COUNT}" >> $GITHUB_OUTPUT
          echo "stats=${STATS}" >> $GITHUB_OUTPUT
          echo "changed_files=${FORMATTED_FILES}" >> $GITHUB_OUTPUT
          echo "pr_info=${PR_INFO}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "pr_title=${PR_TITLE}" >> $GITHUB_OUTPUT

      - name: Send to Slack
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "üöÄ New deployment to main: ${{ steps.extract.outputs.commit_message }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ Production Deployment",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Deployed By:*\n<${{ steps.extract.outputs.actor_url }}|${{ steps.extract.outputs.actor }}>"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üë®‚Äçüíª Code Author:*\n${{ steps.extract.outputs.author_link }}\n${{ steps.extract.outputs.author_email }}"
                  }
                }
                ${{ steps.extract.outputs.pr_info != '' && ',{
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "' || '' }}${{ steps.extract.outputs.pr_info }}${{ steps.extract.outputs.pr_info != '' && '"
                  }
                }' || '' }}
                ,
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üì¶ Commit Message:*\n```${{ steps.extract.outputs.commit_message }}```"
                  }
                }
                ${{ steps.extract.outputs.commit_body != '' && ',{
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üìÑ Commit Description:*\n' || '' }}${{ steps.extract.outputs.commit_body }}${{ steps.extract.outputs.commit_body != '' && '"
                  }
                }' || '' }}
                ,
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*üìä Files Changed:*\n${{ steps.extract.outputs.changed_files_count }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*üìà Git Stats:*\n${{ steps.extract.outputs.stats }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üìÅ Modified Files:*\n${{ steps.extract.outputs.changed_files }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*üïê Timestamp:*\n${{ steps.extract.outputs.commit_date }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*üîó Links:*\n‚Ä¢ <${{ steps.extract.outputs.commit_url }}|View Commit>\n‚Ä¢ <https://github.com/${{ github.repository }}|Repository>"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Commit ID: ${{ steps.extract.outputs.commit_short_hash }} | Triggered via: ${{ github.event_name }}"
                    }
                  ]
                }
              ]
            }
