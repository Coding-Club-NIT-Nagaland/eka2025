name: Slack ‚Äì Commit Notification

on:
  push:
    branches: [main]

jobs:
  slack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Get commit info
        id: commit
        run: |
          echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=format:'%an <%ae>')" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "date=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
      
      - name: Send Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # URLs
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.commit.outputs.hash }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          
          # Build payload - SIMPLE and WORKING
          payload='{
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üöÄ New Deployment to Main",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n'"${{ github.repository }}"'"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Deployed By:*\n'"${{ github.actor }}"'"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üë§ Who wrote the code:*\n'"${{ steps.commit.outputs.author }}"'"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üìù What they did:*\n```'"${{ steps.commit.outputs.message }}"'```"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*üïê When:*\n'"${{ steps.commit.outputs.date }}"'"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*üîó Commit:*\n<'"$COMMIT_URL"'|'"${{ steps.commit.outputs.short_hash }}"'>"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üìù View Commit",
                      "emoji": true
                    },
                    "url": "'"$COMMIT_URL"'",
                    "style": "primary"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "‚öôÔ∏è View Run",
                      "emoji": true
                    },
                    "url": "'"$RUN_URL"'"
                  }
                ]
              }
            ]
          }'
          
          curl -X POST \
            -H 'Content-type: application/json' \
            --data "$payload" \
            "$SLACK_WEBHOOK_URL"
